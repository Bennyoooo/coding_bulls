<%= form_with(model: post, remote: true) do |form| %>
  <% if post.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(post.errors.count, "error") %> prohibited this post from being saved:</h2>

      <ul>
      <% post.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="input-group new-post-field">
    <span class="input-group-addon" id="basic-addon1">Caption</span>
    <%= form.text_field :caption, class: "form-control" %>
  </div>

  <div class="input-group new-post-field">
    <span class="input-group-addon" id="basic-addon1">Content</span>
    <%= form.text_area :content, class: "form-control", id: "content-form" %>
  </div>

  <div>
    <%= form.text_field :category_id, class: "form-control hidden", id: "content-form" %>
  </div>

  <div class="new-post-field img-div">
    <span class="input-group-addon" id="basic-addon1">Choose File</span>
    <%= form.file_field :image, accept: "image/png,image/gif,image/jpeg", class: "form-control file-upload" %>
  </div>

  <div class="category-list">
    <%= link_to "#", method: :post, class: "btn btn-success none-btn category-btn", remote: true do %>
        None
    <% end %>
    <% current_user.categories.each do |c| %>
      <%= link_to "#", method: :post, class: "btn btn-success category-btn", id: c.id, remote: true do %>
        <%= c.name %>
      <% end %>
    <% end %> 
  </div>

  <div class="actions">
    <%= form.button :submit, class: 'btn btn-primary' %>
  </div>
<% end %>

<hr>
<h4> Cannot find the category you need? Click the button below to add a category </h4>

<button class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">New Category</button>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">New Category</h4>
      </div>
      <div class="modal-body">
        <%= form_with(url: '/categories', method: :post, remote: true) do |form| %>
          <div class="input-group row">
            <div class="col-xs-8">
            <%= form.text_field :name, class: "form-control", placeholder: "Search for..." %>
            </div>
            <div class="col-xs-2">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            <div class="col-xs-2">
            <%= form.button :submit, class: 'btn btn-primary submit-btn' %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
  .new-post-field {
    margin-bottom: 12px;
  }
  .category-list {
    margin-bottom: 10px;
  }
  .category-btn {
    background-color: grey;
    border-color: grey;
    color: white;
  }
  .none-btn {
    background-color: #5cb85c;
    border-color: #5cb85c;
    color: white;
  }
  .img-preview {
    margin-top: 7px;
  }
  textarea {
    /* margin:0px 0px; this is redundant anyways since its specified below*/
    padding-top:10px;
    padding-bottom:25px; /* increased! */
    /* height:16px; */
    /* line-height:16px; */
    width:100%; /* changed from 96 to 100% */
    display:block;
    /* margin:0px auto; not needed since i have width 100% now */
  }
</style>



<script>
  function expandTextarea() {
      document.getElementById('content-form').addEventListener('keyup', function() {
          this.style.overflow = 'hidden';
          this.style.height = 0;
          this.style.height = this.scrollHeight + 'px';
      }, false);
  }
  expandTextarea();

  function initialize() {
    $('.category-btn').click(function() {
      $(this).css("background-color", '#5cb85c');
      $(this).css("border-color", '#5cb85c');
      $(this).css("color", 'white');
      $(this).siblings().css("background-color", 'grey');
      $(this).siblings().css("border-color", 'grey');
      $('input[name="post[category_id]"]').val($(this).attr('id'));
    });
  }
  initialize()

  $(".submit-btn").on('click', function(e) {
    $('#exampleModal').delay(2000).modal('hide')
  });

  $('#exampleModal').on('hidden.bs.modal', function (e) {
    $.ajax({
        type: 'GET',
        url: "/categories/1",
        datatype: "json",
        success: function (data) {
          if (data.id != $('.category-btn').last().attr('id')) {
            var $new_btn = $("<a>", {id: data.id, "class": "btn btn-success category-btn", html: data.name});
            $new_btn.css("margin-left", "4px")
            $('.category-list').append($new_btn)
            initialize()
          }
          else {
            assert('repetitive name!')
          }
          console.log(data.name)
        }
    });
  })
  $('.file-upload').on('change', function readURL(e) {
    if (this.files && this.files[0]) {
      var reader = new FileReader();

      reader.onload = function (e) {
        if ($(".img-preview").length == 0) {
          var $img = $("<img>", {src: e.target.result, "class": "img-preview"})
          $(".img-div").append($img)
        }
        else {
          $(".img-preview").attr('src', e.target.result)
        }
      };

      reader.readAsDataURL(this.files[0]);
    }
  })
</script>